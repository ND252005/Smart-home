<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Pro</title>
    <style>
        /* --- CSS GIAO DI·ªÜN --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max_width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        h2 { border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-top: 0; }
        
        /* Input & Button */
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.danger { background: #dc3545; }

        /* M√†n h√¨nh */
        .screen { display: none; }
        .active { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* L∆∞·ªõi ESP (Card Grid) */
        .esp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        
        /* Th·∫ª ESP (Card Style) */
        .esp-card { background: #fff; border: 1px solid #e1e4e8; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .esp-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .esp-name { font-weight: bold; font-size: 1.1em; color: #2c3e50; }
        .esp-hash { font-size: 0.8em; color: #888; background: #f8f9fa; padding: 3px 6px; border-radius: 4px; }
        
        /* Controller Device Row */
        .device-row { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 8px; }
        .device-name-input { border: none; background: transparent; font-weight: 500; font-size: 1em; width: 120px; border-bottom: 1px dashed #ccc; }
        .device-name-input:focus { outline: none; border-bottom: 1px solid #007bff; background: white; }
        
        /* Toggle Button */
        .toggle-btn { padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; border: 1px solid transparent; min-width: 60px; }
        .is-on { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .is-off { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }

        /* Sensor Data */
        .sensor-data { display: flex; justify-content: space-around; margin-top: 15px; }
        .sensor-item { text-align: center; }
        .sensor-val { font-size: 1.4em; font-weight: bold; color: #3498db; }
        .sensor-label { font-size: 0.8em; color: #666; }

        /* Icon Home */
        .home-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .home-card { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; cursor: pointer; text-align: center; transition: 0.3s; }
        .home-card:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4); }
        /* Input nh·∫≠p t√™n ESP (Style cho gi·ªëng ti√™u ƒë·ªÅ) */
        .esp-name-input {
            border: none;
            background: transparent;
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
            width: 200px;
            border-bottom: 1px dashed transparent;
            transition: 0.2s;
        }
        .esp-name-input:hover {
            border-bottom: 1px dashed #999;
            cursor: text;
        }
        .esp-name-input:focus {
            outline: none;
            border-bottom: 1px solid #3498db;
            background-color: #fff;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen" class="screen active">
        <h1 style="text-align:center">üîê Smart Home Login</h1>
        <div style="max-width: 400px; margin: 0 auto;">
            <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
            <button onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button>
            <p onclick="showScreen('signup-screen')" style="text-align:center; color:#007bff; cursor:pointer; margin-top:10px">ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</p>
        </div>
    </div>

    <div id="signup-screen" class="screen">
        <h2 style="text-align:center">ƒêƒÉng K√Ω</h2>
        <div style="max-width: 400px; margin: 0 auto;">
            <input type="text" id="su-user" placeholder="Username">
            <input type="password" id="su-pass" placeholder="Password">
            <input type="text" id="su-name" placeholder="T√™n hi·ªÉn th·ªã">
            <button onclick="handleSignup()">ƒêƒÉng K√Ω Ngay</button>
            <button class="secondary" onclick="showScreen('login-screen')" style="margin-top:10px">H·ªßy</button>
        </div>
    </div>

    <div id="dashboard-screen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h2 id="welcome-msg">Danh s√°ch nh√†</h2>
            <button class="secondary" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
        
        <div style="margin: 20px 0; display:flex; gap:10px">
            <input type="text" id="new-home-name" placeholder="T√™n nh√† m·ªõi..." style="margin:0; width:auto; flex-grow:1">
            <button onclick="createHome()" style="width:auto">‚ûï T·∫°o Nh√†</button>
        </div>

        <div id="home-list" class="home-list">Loading...</div>
    </div>

    <div id="device-screen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h2 id="current-home-title">Chi ti·∫øt nh√†</h2>
            <button class="secondary" onclick="backToDashboard()" style="width:auto">‚¨Ö Quay l·∫°i</button>
        </div>

        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px; border:1px dashed #ccc">
            <b>‚ûï Th√™m thi·∫øt b·ªã m·ªõi (ESP32)</b>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
                <input id="esp-hash" placeholder="M√£ Hash (VD: 246F...)" style="flex:1; margin:0">
                <input id="esp-name" placeholder="T√™n ESP (VD: B·ªô ƒëi·ªÅu khi·ªÉn 1)" style="flex:1; margin:0">
                <div style="display:flex; align-items:center; gap:5px; background:white; padding:0 10px; border-radius:5px; border:1px solid #ddd">
                    <input type="checkbox" id="esp-is-sensor" style="width:auto; margin:0">
                    <label for="esp-is-sensor" style="font-size:0.9em; cursor:pointer">L√† Sensor?</label>
                </div>
                <button onclick="registerESP()" style="width:auto">Th√™m</button>
            </div>
        </div>

        <div id="esp-container" class="esp-grid">
            </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080";
    let CURRENT_USER = null;
    let CURRENT_HOME = null;
    let REFRESH_TIMER = null;

    // --- AUTH ---
    async function handleLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            if(res.ok) {
                CURRENT_USER = await res.json();
                document.getElementById('welcome-msg').innerText = `Xin ch√†o, ${CURRENT_USER.username}`;
                showScreen('dashboard-screen');
                loadHomes();
            } else alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
        } catch(e) { alert("L·ªói k·∫øt n·ªëi"); }
    }

async function handleSignup() {
        // 1. L·∫•y d·ªØ li·ªáu t·ª´ c√°c √¥ input (D·ª±a tr√™n ID trong HTML)
        const username = document.getElementById('su-user').value;
        const password = document.getElementById('su-pass').value;
        const displayName = document.getElementById('su-name').value;

        // 2. Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
        if (!username || !password) {
            alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n ƒëƒÉng nh·∫≠p v√† M·∫≠t kh·∫©u!");
            return;
        }

        try {
            // 3. G·ªçi API ƒêƒÉng k√Ω (POST /users/)
            const res = await fetch(`${API_URL}/users/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    display_name: displayName,
                    email: null // G·ª≠i null n·∫øu giao di·ªán kh√¥ng c√≥ √¥ nh·∫≠p email
                })
            });

            // 4. X·ª≠ l√Ω k·∫øt qu·∫£ tr·∫£ v·ªÅ
            if (res.ok) {
                alert("‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
                
                // X√≥a tr·∫Øng form ƒë·ªÉ l·∫ßn sau nh·∫≠p ti·∫øp
                document.getElementById('su-user').value = "";
                document.getElementById('su-pass').value = "";
                document.getElementById('su-name').value = "";

                // Chuy·ªÉn ngay v·ªÅ m√†n h√¨nh ƒëƒÉng nh·∫≠p
                showScreen('login-screen');
            } else {
                // N·∫øu Server b√°o l·ªói (v√≠ d·ª•: Username ƒë√£ t·ªìn t·∫°i)
                const err = await res.json();
                alert("‚ùå ƒêƒÉng k√Ω th·∫•t b·∫°i: " + err.detail);
            }
        } catch (e) {
            console.error(e);
            alert("‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn Server!");
        }
    }
    // --- HOMES ---
    async function loadHomes() {
        const res = await fetch(`${API_URL}/users/${CURRENT_USER.user_id}`);
        const data = await res.json();
        const list = document.getElementById('home-list');
        list.innerHTML = "";
        
        data.homes.forEach(h => {
            const div = document.createElement('div');
            div.className = 'home-card';
            div.innerHTML = `<h3>üè† ${h.name}</h3><p>ID: ${h.id}</p>`;
            div.onclick = () => openHome(h);
            list.appendChild(div);
        });
    }

    async function createHome() {
        const name = document.getElementById('new-home-name').value;
        if(!name) return;
        await fetch(`${API_URL}/homes/`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name: name, owner_id: CURRENT_USER.user_id})
        });
        document.getElementById('new-home-name').value="";
        loadHomes();
    }

    // --- ESP & DEVICES (LOGIC QUAN TR·ªåNG) ---
    function openHome(home) {
        CURRENT_HOME = home;
        document.getElementById('current-home-title').innerText = `Qu·∫£n l√Ω: ${home.name}`;
        showScreen('device-screen');
        loadHomeData();
        
        if(REFRESH_TIMER) clearInterval(REFRESH_TIMER);
        REFRESH_TIMER = setInterval(loadHomeData, 2000); // C·∫≠p nh·∫≠t m·ªói 2s
    }
    
async function loadHomeData() {
        const resHome = await fetch(`${API_URL}/homes/${CURRENT_HOME.id}`);
        const homeData = await resHome.json();
        
        const container = document.getElementById('esp-container');
        let html = "";

        // Ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ ƒëang focus v√†o √¥ input n√†o kh√¥ng
        // N·∫øu c√≥, ta s·∫Ω gi·ªØ nguy√™n gi√° tr·ªã √¥ ƒë√≥, kh√¥ng ghi ƒë√®
        const activeElement = document.activeElement;
        const activeInputId = activeElement && activeElement.tagName === "INPUT" ? activeElement.id : null;
        const activeInputValue = activeElement ? activeElement.value : null;

        for (const esp of homeData.esps) {
            if (esp.is_sensor) {
                // ... (Ph·∫ßn code Sensor gi·ªØ nguy√™n nh∆∞ c≈©) ...
                const resState = await fetch(`${API_URL}/api/sensor/state/${esp.hash_id}`);
                const state = await resState.json();
                
                html += `
                <div class="esp-card">
                    <div class="esp-header">
                        <div style="display:flex; align-items:center; gap:5px">
                            <span>üì°</span>
                            <input class="esp-name-input" id="esp-name-${esp.hash_id}"
                                   value="${esp.name}" 
                                   onchange="renameESP('${esp.hash_id}', this.value)">
                        </div>
                        <span class="esp-hash">#${esp.hash_id}</span>
                    </div>
                    <div class="sensor-data">
                        <div class="sensor-item"><div class="sensor-val">${state.data.temperature}¬∞C</div><div class="sensor-label">Nhi·ªát</div></div>
                        <div class="sensor-item"><div class="sensor-val">${state.data.humidity}%</div><div class="sensor-label">·∫®m</div></div>
                        <div class="sensor-item"><div class="sensor-val">${state.data.gas_detect}</div><div class="sensor-label">Gas</div></div>
                    </div>
                    <div style="text-align:center; margin-top:10px; font-size:0.8em; color:${esp.is_active?'green':'gray'}">‚óè ${esp.is_active ? 'Online' : 'Offline'}</div>
                </div>`;
            } else {
                // ... (Ph·∫ßn Controller) ...
                let deviceRows = "";
                esp.devices.forEach(dev => {
                    const isOn = dev.status_value === 1;
                    // Logic ∆∞u ti√™n: N·∫øu c√≥ display_name th√¨ d√πng, kh√¥ng th√¨ d√πng name g·ªëc
                    const showName = dev.display_name || dev.name; 
                    
                    // T·∫°o ID duy nh·∫•t cho √¥ input ƒë·ªÉ check focus
                    const inputId = `dev-input-${dev.id}`;
                    
                    // N·∫øu √¥ n√†y ƒëang ƒë∆∞·ª£c user g√µ, ta d√πng gi√° tr·ªã user ƒëang g√µ (activeInputValue)
                    // N·∫øu kh√¥ng, ta d√πng gi√° tr·ªã t·ª´ Server (showName)
                    const valueToRender = (activeInputId === inputId) ? activeInputValue : showName;

                    deviceRows += `
                    <div class="device-row">
                        <input class="device-name-input" 
                               id="${inputId}"
                               value="${valueToRender}" 
                               onchange="renameDevice(${dev.id}, this.value)" 
                               title="Nh·∫•n ƒë·ªÉ ƒë·ªïi t√™n">
                        
                        <button class="toggle-btn ${isOn?'is-on':'is-off'}" 
                                onclick="toggleDevice('${esp.hash_id}', '${dev.name}', ${dev.status_value})">
                            ${isOn ? 'ON' : 'OFF'}
                        </button>
                    </div>`;
                });

                html += `
                <div class="esp-card">
                    <div class="esp-header">
                        <div style="display:flex; align-items:center; gap:5px">
                            <span>üí°</span>
                            <input class="esp-name-input" id="esp-name-${esp.hash_id}"
                                   value="${esp.name}" 
                                   onchange="renameESP('${esp.hash_id}', this.value)">
                        </div>
                        <span class="esp-hash">#${esp.hash_id}</span>
                    </div>
                    <div>${deviceRows}</div>
                    <div style="text-align:center; margin-top:10px; font-size:0.8em; color:${esp.is_active?'green':'gray'}">‚óè ${esp.is_active ? 'Online' : 'Offline'}</div>
                </div>`;
            }
        }
        
        container.innerHTML = html;
        
        // Restore focus l·∫°i v√†o √¥ input sau khi v·∫Ω l·∫°i (ƒë·ªÉ user g√µ ti·∫øp ƒë∆∞·ª£c)
        if (activeInputId) {
            const inputToFocus = document.getElementById(activeInputId);
            if (inputToFocus) {
                inputToFocus.focus();
                // ƒê·∫∑t con tr·ªè chu·ªôt v·ªÅ cu·ªëi d√≤ng ch·ªØ (tr·∫£i nghi·ªám t·ªët h∆°n)
                const val = inputToFocus.value;
                inputToFocus.value = '';
                inputToFocus.value = val;
            }
        }
    }

    // --- ACTIONS ---
    async function registerESP() {
        const hash = document.getElementById('esp-hash').value;
        const name = document.getElementById('esp-name').value;
        const isSensor = document.getElementById('esp-is-sensor').checked;
        
        if(!hash) return alert("Nh·∫≠p Hash ƒëi!");

        const res = await fetch(`${API_URL}/esps/register`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                hash_id: hash, name: name || hash,
                home_id: CURRENT_HOME.id, is_sensor: isSensor
            })
        });
        
        if(res.ok) {
            alert("Th√™m th√†nh c√¥ng!");
            document.getElementById('esp-hash').value="";
            loadHomeData();
        } else {
            const err = await res.json();
            alert("L·ªói: " + err.detail);
        }
    }

    async function toggleDevice(hash, devName, currentStatus) {
        const newStatus = currentStatus === 1 ? 0 : 1;
        await fetch(`${API_URL}/esps/${hash}/control`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ device_name: devName, status: newStatus })
        });
        loadHomeData();
    }

    async function renameDevice(deviceId, newName) {
        if(!newName) return;
        await fetch(`${API_URL}/devices/${deviceId}`, {
            method: 'PUT', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ display_name: newName })
        });
        // Kh√¥ng c·∫ßn reload, ƒë·ªÉ polling t·ª± lo ho·∫∑c reload ƒë·ªÉ ch·∫Øc ch·∫Øn
    }
    function logout() { location.reload(); }
    
    
    async function renameESP(hashId, newName) {
        if(!newName) return;
        try {
            await fetch(`${API_URL}/esps/${hashId}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name: newName })
            });
            // Kh√¥ng c·∫ßn reload hay alert, ƒë·ªÉ ng∆∞·ªùi d√πng c·∫£m th·∫•y m∆∞·ª£t
            console.log("ƒê√£ ƒë·ªïi t√™n ESP th√†nh: " + newName);
        } catch(e) {
            alert("L·ªói khi ƒë·ªïi t√™n ESP");
        }
    }
    // --- NAV ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function backToDashboard() {
        if(REFRESH_TIMER) clearInterval(REFRESH_TIMER);
        showScreen('dashboard-screen');
    }


</script>
</body>
</html>